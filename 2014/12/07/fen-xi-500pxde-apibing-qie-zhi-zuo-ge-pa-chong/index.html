<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>用python制作一个简单爬虫下载500px的图片 | Hexo</title>
  <meta name="author" content="John Doe">

  
  <meta name="description" content="500px.com是一个专业的摄影图片社区，在500px上可以发现和分享高质量的图片，它的Logo是“最出色的摄影社区”。我在他的网站上找到很多喜爱的图片。但是，当你发现自己喜爱的图片然后右键的时候，糟糕，提示“copyright blabla”,反正就是不让下载。今天，我在这里记录我分析他的API">
  
  

  <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
</head>

<body>
  <header id="header" class="inner"><nav>
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
</nav></header>
  <div id="content" class="inner"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <header>
    
  
    <h1 class="title">用python制作一个简单爬虫下载500px的图片</h1>
  

    <time datetime="2014-12-07T16:37:46.000Z">
  <span class="day">7</span><span class="month">Dec</span>
</time>
  </header>
  <div class="entry-content">
    
      <p>500px.com是一个专业的摄影图片社区，在500px上可以发现和分享高质量的图片，它的Logo是“最出色的摄影社区”。我在他的网站上找到很多喜爱的图片。但是，当你发现自己喜爱的图片然后右键的时候，糟糕，提示“copyright blabla”,反正就是不让下载。今天，我在这里记录我分析他的API，并且用python自动抓取图片的过程。</p>
<p>####获得图片<br>500px阻止了右键下载的功能，当然，突破这个限制很简单，只要在chrome浏览器里开启调试模式，然后在Elements里搜索”jpg”，就可以找到下载地址。它的下载地址是这样一个形式的。可以很轻松的找到需要的下载地址。<br><img src="/content/images/2014/12/QQ--20141208004913.png" alt="图片"></p>
<p>获得一张图片的地址，还不够，我还想写个脚本自动抓取它的图片，本来以为像平常一样简单，但是真正去抓的时候，却遇到点麻烦。</p>
<p>####动态网站？怎么抓<br>我在获得popular页（popular页是所有图片的开始）的数据之后，使用正则表达式搜索其中的链接，奇怪是没有找到任何图片链接，因为我学python做爬虫也没多久，所以我并不知道是怎么回事。我把抓过来的页面写到文件里，然后用编辑器打开。突然恍然大悟。推荐页面的图片都是动态加载的。必须在浏览器里运行javascript后才能得到目标页面。但是我的爬虫过于简陋显然是没办法运行javascript的，也就谈不上抓取真正想要数据。  </p>
<p>现在怎么办？动态页面？我没有办法，只好向室友请教（室友是个经验丰富的大牛）。他告诉我，我需要webkit。 嗯。又学到了一个新东西。他就帮我google，发现了pyv8。让我去看看。  </p>
<p>pyv8，竟然还有python的V8引擎，好东西。可是我不会用。。。我这会有搜索了一下其他的webkit。知道了没有界面的headless webkit是我想要的东西，其中PhantomJS 是一个非常好的webkit。但是我要用python，PhantomJs 是javascript的，我看到一些在python里使用PhantomJs的方法，也尝试了一下。但是在安装阶段，卧槽，莫名其妙的错误（写博客的时候已经忘了当时什么错误了，反正玩linux经常回出现各种莫名其妙的错误）。blalba， 在webkit这块折腾了许久，没搞定，其中还发现了Ghost这么一个包，可以直接来抓动态网页，好厉害，可是我用的python3，在我机器上没有安装成功。  </p>
<p>一顿折腾，我打算放弃的时候，想到在知乎上好像看到一个方法“找到网站的API,直接获取数据”。接下来就是进入分析阶段了。</p>
<p>####获得json数据</p>
<p>首先还要进入浏览器的调试模式，进入500px的推荐页面。看到过程是下边这样的。<br><img src="/content/images/2014/12/QQ--20141208011307.png" alt="数据传送过程">  </p>
<p>可以看到，一开始获得“没有价值的”首页，然后出现一个ping ，看到ping的地址，就马上知道这就是我们的目标了。记下来都是获得的各种css和js文件。继续往下看，发现在开始获取图片资源以前又get了一次api请求。<br><img src="/content/images/2014/12/QQ--20141208011616.png" alt=""></p>
<p>这时候点开这个请求，发现是个json数据，经过观察，就是首页推荐里的所有图片的信息。<br><img src="/content/images/2014/12/QQ--20141208011658.png" alt=""></p>
<p>这时候的目标就很简单了，看给Api发出的请求，然后伪造请求。<br><img src="/content/images/2014/12/QQ--20141208011710.png" alt=""></p>
<p>在试了几次之后，发现其中的auth-token是很重要的，否则就请求一定会被拒绝。但是auth-token从哪里来，cookie里没有，找啊找，最后发现auth-token就在首页的head区域中。  </p>
<p>接下来的过程自然就是获取推荐页，获得auth-token，然后伪造请求向api发数据（我还模仿浏览器先ping了一下），从json中获得图片的下载链接。在处理json时，用Python3自带的json处理包可以很方便的处理数据。这里有意思的是，它发回的json包里的下载地址都是4.jpg结尾，但是把4改成5之后，获得的图片就比较更清晰（实际上因为高清原图都要买，我还没法弄到）。</p>
<p>由于学python还没多久，所以编程上还不是很好，后来想将程序改成一个class，也遇到困难，干脆不做了，毕竟只是一个用用就不用的脚本，不是当做产品的。</p>
<p>我的代码：  </p>
<pre><code><span class="comment"># a python program to grap 500pk and download pictures</span>
<span class="comment"># author: Aaron</span>
<span class="comment"># 3 Feb 2014</span>

<span class="keyword">import</span> urllib.request
<span class="keyword">import</span> urllib.parse
<span class="keyword">import</span> re
<span class="keyword">import</span> http.cookiejar
<span class="keyword">import</span> time
<span class="keyword">import</span> json
<span class="keyword">import</span> pickle
<span class="keyword">import</span> os
<span class="keyword">import</span> os.path
<span class="keyword">import</span> queue

BASE_URL = <span class="string">'https://500px.com/'</span>
START_URL = <span class="string">'https://500px.com/popular'</span>
<span class="comment">#API = "https://api.500px.com/v1/photos?rpp=38&amp;feature=popular&amp;image_size%5B%5D=3&amp;image_size%5B%5D=4&amp;\</span>
<span class="comment">#page="+page+"&amp;sort=&amp;include_states=true&amp;formats=jpeg%2Clytro&amp;only=&amp;authenticity_token="</span>
API_BASE = <span class="string">"https://api.500px.com/v1/photos?"</span>
Cauth_token = <span class="string">'A%2Be7bNn8RWMGBFySgzumEk3AZhzqXQ0JPs3zUScmm0%3D'</span>
API_PING = <span class="string">'https://api.500px.com/v1/ping'</span>
SAVE_PATH = <span class="string">'./image/'</span>

query = {<span class="string">'rpp'</span>: [<span class="string">'38'</span>],
         <span class="string">'feature'</span>: [<span class="string">'popular'</span>],
         <span class="string">'image_size[]'</span>: [<span class="string">'3'</span>, <span class="string">'4'</span>],
         <span class="string">'page'</span>: [<span class="string">'1'</span>],
         <span class="string">'sort'</span>: [<span class="string">''</span>],
         <span class="string">'include_states'</span>: [<span class="string">'true'</span>], 
         <span class="string">'formats'</span>: [<span class="string">'jpeg,lytro'</span>],
         <span class="string">'only'</span>: [<span class="string">''</span>],              <span class="comment">#category, leave blank for all.</span>
         <span class="string">'authenticity_token'</span>: [<span class="string">''</span>]
         }
start = <span class="number">1</span>
end = <span class="number">10</span>

visited = []
wait_list = queue.Queue()


<span class="comment">#build opener</span>
cj = http.cookiejar.CookieJar()
opener = urllib.request.build_opener(urllib.request.HTTPCookieProcessor(cj))
opener.addheaders = [(<span class="string">'User-Agent'</span>,<span class="string">' Mozilla/5.0 (Windows NT 6.3; Win64; x64)\
                     AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.122 Safari/537.36'</span>)]

<span class="function"><span class="keyword">def</span> <span class="title">get_token</span><span class="params">(taget_url)</span>:</span>
    <span class="keyword">with</span> opener.open(taget_url) <span class="keyword">as</span> f:
        data = f.read().decode()
        <span class="comment">#print(data)</span>
        pattern = <span class="string">'&lt;a data-bind="photo_link" data-ga-action="Image" data-ga-category="Photo Thumbnail" href="\S*" id="\S*"&gt;'</span>
        test_pat = <span class="string">'href="\S*"'</span>
        test_data = re.search(test_pat,data)
        print(test_data.group())
        pic_reg = re.compile(pattern)
        res = pic_reg.search(data)
        print(res)
        auth_patt = <span class="string">'content="(?P&lt;auth_token&gt;\S*)".name="csrf-token"'</span>
        auth = re.search(auth_patt,data)
        print(<span class="string">'auth'</span>,auth.group(<span class="string">'auth_token'</span>))
        auth_token = auth.group(<span class="string">'auth_token'</span>)
    save_file = open(<span class="string">'test.html'</span>,<span class="string">'w+'</span>)
    save_file.write(data)
    save_file.close()
    <span class="keyword">return</span> auth_token

<span class="function"><span class="keyword">def</span> <span class="title">save_image</span><span class="params">(image)</span>:</span>
    <span class="keyword">pass</span>

<span class="function"><span class="keyword">def</span> <span class="title">get_image</span><span class="params">(photo)</span>:</span>
    <span class="string">'''
    get and save the image
    '''</span>
    image_url = photo[<span class="string">'image_url'</span>][<span class="number">1</span>]
    image_id = photo[<span class="string">'id'</span>]
    image_category = photo[<span class="string">'category'</span>]
    path = SAVE_PATH + str(image_category)+<span class="string">'/'</span>
    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):
        os.mkdir(path)
    <span class="keyword">with</span> opener.open(image_url) <span class="keyword">as</span> res:
        image = res.read()
        <span class="keyword">with</span> open(path+str(image_id)+<span class="string">'.jpg'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> file:
            file.write(image)
        file.close()
        <span class="comment">#print(photo_id,'is ok')</span>

<span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">()</span>:</span>
    opener.addheaders = [(<span class="string">'Origin'</span>,<span class="string">'https://500px.com'</span>),(<span class="string">'Referer'</span>,<span class="string">'https://500px.com/popular'</span>)]
    opener.open(API_PING)

<span class="function"><span class="keyword">def</span> <span class="title">get_list</span><span class="params">(API)</span>:</span>
    <span class="keyword">global</span> wait_list
    <span class="keyword">global</span> visited
    print(<span class="string">"reading list"</span>)
    <span class="keyword">with</span> opener.open(API) <span class="keyword">as</span> f:
        json_data = f.read().decode()
    pic_list = json.loads(json_data)
    <span class="keyword">for</span> photo <span class="keyword">in</span> pic_list[<span class="string">'photos'</span>]:
        <span class="keyword">if</span> photo[<span class="string">'id'</span>] <span class="keyword">not</span> <span class="keyword">in</span> visited:
            photo[<span class="string">'image_url'</span>][<span class="number">1</span>] = photo[<span class="string">'image_url'</span>][<span class="number">1</span>].replace(<span class="string">'4.jpg'</span>,<span class="string">'5.jpg'</span>)
            wait_list.put(photo)
    print(<span class="string">'dowloaded:'</span>,len(visited))
    print(<span class="string">'to be dowloaded:'</span>,wait_list.qsize())
    json_file = open(<span class="string">'pics.json'</span>,<span class="string">'w+'</span>)
    json_file.write(json_data)
    json_file.close()

<span class="function"><span class="keyword">def</span> <span class="title">handle_wait_list</span><span class="params">(page)</span>:</span>
    total = wait_list.qsize()
    count = <span class="number">0</span>
    <span class="keyword">while</span> <span class="keyword">not</span> wait_list.empty():
        photo = wait_list.get()
        get_image(photo)
        count = count + <span class="number">1</span>
        percentage = <span class="number">100.0</span>*count/total
        print(<span class="string">"%.1f%% is done on this page %d"</span> %(percentage,page))
        id = photo[<span class="string">'id'</span>]
        visited.append(photo[<span class="string">'id'</span>])

<span class="function"><span class="keyword">def</span> <span class="title">get_page</span><span class="params">(page)</span>:</span>    
    print(<span class="string">'Dolowding page: '</span>,page)
    query[<span class="string">'page'</span>] = [str(page),]
    API = API_BASE + urllib.parse.urlencode(query,doseq=<span class="keyword">True</span>)
    ping()
    print(<span class="string">'Reading list on page %d.'</span> %page)
    get_list(API) 
    print(<span class="string">'Starting download the images.'</span>)
    handle_wait_list(page)
    print(<span class="string">'Page %d is handled successfully.'</span> %page)
    save_visited()

<span class="function"><span class="keyword">def</span> <span class="title">save_visited</span><span class="params">()</span>:</span>
    <span class="keyword">with</span> open(<span class="string">'visited'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:
        pickle.dump(visited,f)

<span class="function"><span class="keyword">def</span> <span class="title">load_visited</span><span class="params">()</span>:</span>
    <span class="keyword">global</span> visited
    print(<span class="string">'Starting...'</span>)
    <span class="keyword">with</span> open(<span class="string">'visited'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:
        visited = pickle.load(f)
    <span class="comment">#print(visited)</span>

<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
    <span class="keyword">try</span>:
        load_visited()
    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:
        print(err)
    auth_token = get_token(START_URL)
    query[<span class="string">'authenticity_token'</span>] = [auth_token,]
    <span class="keyword">while</span> <span class="keyword">True</span>:
        <span class="keyword">for</span> page <span class="keyword">in</span> range(start,end):
            get_page(page)
        time.sleep(<span class="number">600</span>)


<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    <span class="keyword">try</span>:
        main()
    <span class="keyword">except</span> KeyboardInterrupt:
        print(<span class="string">'Exiting, please wait'</span>)
        save_visited()
    <span class="comment">#except Exception as err:</span>
    <span class="comment">#    print('Somthing is wrong. Exiting...')</span>
    <span class="comment">#    print(err)</span>
</code></pre>
    
    
    <footer class="meta">
      
      
      
    </footer>
    
  </div>
  
</article></div>
  <footer id="footer" class="inner"><div class="social alignright">
  
  
  
  
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
</div>
<p>
  
  &copy; 2015 John Doe
  
</p>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id="phasebeam">
  <canvas></canvas>
  <canvas></canvas>
  <canvas></canvas>
</div>
<script src="/js/phasebeam.js"></script>
</body>
</html>